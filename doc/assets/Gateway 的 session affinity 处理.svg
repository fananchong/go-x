<?xml version="1.0" encoding="utf-8" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 20010904//EN" "http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd"><svg xmlns="http://www.w3.org/2000/svg" width="1502" height="758" xmlns:xlink="http://www.w3.org/1999/xlink"><source><![CDATA[Title: Gateway 的 session affinity 处理
participant Client
participant LoginServer
participant Redis
participant Gateway
Client->LoginServer: 1. 账号登陆
Note right of LoginServer: 1. 账号相关验证（略）
Note right of LoginServer: 2. 本地缓存中选取一个Gateway
LoginServer->Redis: 2.1 SETX NX { uid, gatewayid } 键值对 
Note right of LoginServer: 2.1 如果设置失败 
LoginServer->Redis: 2.1 GET { uid, gatewayid } 键值对 
Redis-->LoginServer: 2.1 返回 gatewayid
Note right of LoginServer: 2.2 如果返回的 gateway 已失效 （小概率）
LoginServer->Redis: 2.2 DELX { uid, gatewayid } 键值对 (本次登陆流程失败)
LoginServer->Redis: 3. SET { uid, token } 键值对
LoginServer-->Client: 4. 返回OK, IP/Port/Token
Note right of Gateway: 5. 账号登陆 Gateway 等等（略）
Gateway->Redis: 5.1 EXPIRE { uid, gatewayid } 键值对（设置过期1年）
Note right of Gateway: 6. 账号连接断开事件触发
Gateway->Redis: 6. EXPIRE { uid, gatewayid } 键值对（设置过期10分钟）]]></source><desc>Gateway 的 session affinity 处理</desc><defs><marker viewBox="0 0 5 5" markerWidth="5" markerHeight="5" orient="auto" refX="5" refY="2.5" id="markerArrowBlock"><path d="M 0 0 L 5 2.5 L 0 5 z"></path></marker><marker viewBox="0 0 9.6 16" markerWidth="4" markerHeight="16" orient="auto" refX="9.6" refY="8" id="markerArrowOpen"><path d="M 9.6,8 1.92,16 0,13.7 5.76,8 0,2.286 1.92,0 9.6,8 z"></path></marker></defs><g class="title"><rect x="10" y="10" width="266" height="26" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="15" y="29" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="15">Gateway 的 session affinity 处理</tspan></text></g><g class="actor"><rect x="10" y="46" width="68" height="36" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="20" y="70" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="20">Client</tspan></text></g><g class="actor"><rect x="10" y="702" width="68" height="36" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="20" y="726" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="20">Client</tspan></text></g><line x1="44" x2="44" y1="82" y2="702" stroke="#000000" fill="none" style="stroke-width: 2;"></line><g class="actor"><rect x="202" y="46" width="108" height="36" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="212" y="70" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="212">LoginServer</tspan></text></g><g class="actor"><rect x="202" y="702" width="108" height="36" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="212" y="726" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="212">LoginServer</tspan></text></g><line x1="256" x2="256" y1="82" y2="702" stroke="#000000" fill="none" style="stroke-width: 2;"></line><g class="actor"><rect x="670" y="46" width="60" height="36" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="680" y="70" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="680">Redis</tspan></text></g><g class="actor"><rect x="670" y="702" width="60" height="36" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="680" y="726" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="680">Redis</tspan></text></g><line x1="700" x2="700" y1="82" y2="702" stroke="#000000" fill="none" style="stroke-width: 2;"></line><g class="actor"><rect x="1106" y="46" width="76" height="36" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="1116" y="70" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="1116">Gateway</tspan></text></g><g class="actor"><rect x="1106" y="702" width="76" height="36" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="1116" y="726" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="1116">Gateway</tspan></text></g><line x1="1144" x2="1144" y1="82" y2="702" stroke="#000000" fill="none" style="stroke-width: 2;"></line><g class="signal"><text x="106" y="113" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="106">1. 账号登陆</tspan></text><line x1="44" x2="256" y1="118" y2="118" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="note"><rect x="276" y="138" width="178" height="26" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="281" y="157" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="281">1. 账号相关验证（略）</tspan></text></g><g class="note"><rect x="276" y="184" width="234" height="26" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="281" y="203" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="281">2. 本地缓存中选取一个Gateway</tspan></text></g><g class="signal"><text x="330" y="241" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="330">2.1 SETX NX { uid, gatewayid } 键值对</tspan></text><line x1="256" x2="700" y1="246" y2="246" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="note"><rect x="276" y="266" width="138" height="26" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="281" y="285" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="281">2.1 如果设置失败</tspan></text></g><g class="signal"><text x="346" y="323" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="346">2.1 GET { uid, gatewayid } 键值对</tspan></text><line x1="256" x2="700" y1="328" y2="328" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="signal"><text x="406" y="359" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="406">2.1 返回 gatewayid</tspan></text><line x1="700" x2="256" y1="364" y2="364" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="note"><rect x="276" y="384" width="330" height="26" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="281" y="403" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="281">2.2 如果返回的 gateway 已失效 （小概率）</tspan></text></g><g class="signal"><text x="266" y="441" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="266">2.2 DELX { uid, gatewayid } 键值对 (本次登陆流程失败)</tspan></text><line x1="256" x2="700" y1="446" y2="446" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="signal"><text x="366" y="477" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="366">3. SET { uid, token } 键值对</tspan></text><line x1="256" x2="700" y1="482" y2="482" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="signal"><text x="54" y="513" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="54">4. 返回OK, IP/Port/Token</tspan></text><line x1="256" x2="44" y1="518" y2="518" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="note"><rect x="1164" y="538" width="250" height="26" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="1169" y="557" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="1169">5. 账号登陆 Gateway 等等（略）</tspan></text></g><g class="signal"><text x="718" y="595" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="718">5.1 EXPIRE { uid, gatewayid } 键值对（设置过期1年）</tspan></text><line x1="1144" x2="700" y1="600" y2="600" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="note"><rect x="1164" y="620" width="194" height="26" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="1169" y="639" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="1169">6. 账号连接断开事件触发</tspan></text></g><g class="signal"><text x="710" y="677" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="710">6. EXPIRE { uid, gatewayid } 键值对（设置过期10分钟）</tspan></text><line x1="1144" x2="700" y1="682" y2="682" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g></svg>
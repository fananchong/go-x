<?xml version="1.0" encoding="utf-8" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 20010904//EN" "http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd"><svg xmlns="http://www.w3.org/2000/svg" width="1034" height="968" xmlns:xlink="http://www.w3.org/1999/xlink"><source><![CDATA[Title: Lobby 的 session affinity 处理
participant Client
participant Gateway
participant Redis
participant Lobby
Client->Gateway: 1.0 登陆 Gateway 
Note right of Gateway: 1.0 客户端连接 Token 验证、Session 创建等等完毕后
Gateway->Redis: 1.1 Get { Client Session Id, Lobby Id } 键值对
Redis-->Gateway: 1.1 返回结果 
Note right of Gateway: 1.2 如果没有或者 Lobby 连接已失效
Note right of Gateway: 1.2 本地缓存中获取 1 Lobby 连接 （轮询方式即可）
Gateway->Redis: 1.2 Set { Client Session Id, Lobby Id } 键值对
Note right of Gateway: 1.3 本地保存 { Client Session Id, Lobby Id } 键值对
Gateway->Client: 1.4 返回登陆 Gateway 成功
Client->Gateway: 2.0 Lobby 协议请求
Note right of Gateway: 2.1 如果 Lobby 连接已失效
Note right of Gateway: 2.1 踢人处理
Gateway->Redis: 2.1 Del { Client Session Id, Lobby Id } 键值对（流程结束）
Note right of Gateway: 2.2 如果 Lobby 连接
Gateway->Lobby: 2.2 转发请求
Note right of Lobby: 2.2 处理请求
Lobby-->Gateway: 2.2 处理结果
Gateway-->Client: 2.2 转发结果
Note right of Gateway: 3. 触发客户端断开连接事件
Gateway->Redis: 3. Del { Client Session Id, Lobby Id } 键值对（流程结束）]]></source><desc>Lobby 的 session affinity 处理</desc><defs><marker viewBox="0 0 5 5" markerWidth="5" markerHeight="5" orient="auto" refX="5" refY="2.5" id="markerArrowBlock"><path d="M 0 0 L 5 2.5 L 0 5 z"></path></marker><marker viewBox="0 0 9.6 16" markerWidth="4" markerHeight="16" orient="auto" refX="9.6" refY="8" id="markerArrowOpen"><path d="M 9.6,8 1.92,16 0,13.7 5.76,8 0,2.286 1.92,0 9.6,8 z"></path></marker></defs><g class="title"><rect x="10" y="10" width="250" height="26" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="15" y="29" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="15">Lobby 的 session affinity 处理</tspan></text></g><g class="actor"><rect x="10" y="46" width="68" height="36" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="20" y="70" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="20">Client</tspan></text></g><g class="actor"><rect x="10" y="912" width="68" height="36" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="20" y="936" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="20">Client</tspan></text></g><line x1="44" x2="44" y1="82" y2="912" stroke="#000000" fill="none" style="stroke-width: 2;"></line><g class="actor"><rect x="226" y="46" width="76" height="36" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="236" y="70" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="236">Gateway</tspan></text></g><g class="actor"><rect x="226" y="912" width="76" height="36" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="236" y="936" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="236">Gateway</tspan></text></g><line x1="264" x2="264" y1="82" y2="912" stroke="#000000" fill="none" style="stroke-width: 2;"></line><g class="actor"><rect x="718" y="46" width="60" height="36" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="728" y="70" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="728">Redis</tspan></text></g><g class="actor"><rect x="718" y="912" width="60" height="36" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="728" y="936" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="728">Redis</tspan></text></g><line x1="748" x2="748" y1="82" y2="912" stroke="#000000" fill="none" style="stroke-width: 2;"></line><g class="actor"><rect x="798" y="46" width="60" height="36" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="808" y="70" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="808">Lobby</tspan></text></g><g class="actor"><rect x="798" y="912" width="60" height="36" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="808" y="936" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="808">Lobby</tspan></text></g><line x1="828" x2="828" y1="82" y2="912" stroke="#000000" fill="none" style="stroke-width: 2;"></line><g class="signal"><text x="90" y="113" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="90">1.0 登陆 Gateway</tspan></text><line x1="44" x2="264" y1="118" y2="118" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="note"><rect x="284" y="138" width="402" height="26" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="289" y="157" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="289">1.0 客户端连接 Token 验证、Session 创建等等完毕后</tspan></text></g><g class="signal"><text x="322" y="195" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="322">1.1 Get { Client Session Id, Lobby Id } 键值对</tspan></text><line x1="264" x2="748" y1="200" y2="200" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="signal"><text x="458" y="231" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="458">1.1 返回结果</tspan></text><line x1="748" x2="264" y1="236" y2="236" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="note"><rect x="284" y="256" width="274" height="26" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="289" y="275" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="289">1.2 如果没有或者 Lobby 连接已失效</tspan></text></g><g class="note"><rect x="284" y="302" width="394" height="26" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="289" y="321" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="289">1.2 本地缓存中获取 1 Lobby 连接 （轮询方式即可）</tspan></text></g><g class="signal"><text x="322" y="359" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="322">1.2 Set { Client Session Id, Lobby Id } 键值对</tspan></text><line x1="264" x2="748" y1="364" y2="364" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="note"><rect x="284" y="384" width="418" height="26" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="289" y="403" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="289">1.3 本地保存 { Client Session Id, Lobby Id } 键值对</tspan></text></g><g class="signal"><text x="54" y="441" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="54">1.4 返回登陆 Gateway 成功</tspan></text><line x1="264" x2="44" y1="446" y2="446" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="signal"><text x="82" y="477" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="82">2.0 Lobby 协议请求</tspan></text><line x1="44" x2="264" y1="482" y2="482" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="note"><rect x="284" y="502" width="210" height="26" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="289" y="521" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="289">2.1 如果 Lobby 连接已失效</tspan></text></g><g class="note"><rect x="284" y="548" width="106" height="26" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="289" y="567" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="289">2.1 踢人处理</tspan></text></g><g class="signal"><text x="274" y="605" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="274">2.1 Del { Client Session Id, Lobby Id } 键值对（流程结束）</tspan></text><line x1="264" x2="748" y1="610" y2="610" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="note"><rect x="284" y="630" width="162" height="26" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="289" y="649" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="289">2.2 如果 Lobby 连接</tspan></text></g><g class="signal"><text x="498" y="687" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="498">2.2 转发请求</tspan></text><line x1="264" x2="828" y1="692" y2="692" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="note"><rect x="848" y="712" width="106" height="26" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="853" y="731" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="853">2.2 处理请求</tspan></text></g><g class="signal"><text x="498" y="769" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="498">2.2 处理结果</tspan></text><line x1="828" x2="264" y1="774" y2="774" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="signal"><text x="106" y="805" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="106">2.2 转发结果</tspan></text><line x1="264" x2="44" y1="810" y2="810" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="note"><rect x="284" y="830" width="210" height="26" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="289" y="849" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="289">3. 触发客户端断开连接事件</tspan></text></g><g class="signal"><text x="278" y="887" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="278">3. Del { Client Session Id, Lobby Id } 键值对（流程结束）</tspan></text><line x1="264" x2="748" y1="892" y2="892" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g></svg>